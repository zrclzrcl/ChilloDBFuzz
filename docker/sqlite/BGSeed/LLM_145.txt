CREATE TABLE products (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    price REAL NOT NULL CHECK (price > 0),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE categories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE
);

CREATE TABLE product_categories (
    product_id INTEGER NOT NULL,
    category_id INTEGER NOT NULL,
    FOREIGN KEY (product_id) REFERENCES products(id),
    FOREIGN KEY (category_id) REFERENCES categories(id),
    UNIQUE (product_id, category_id)
);

INSERT INTO categories (name) VALUES ('Electronics'), ('Books'), ('Clothing');

INSERT INTO products (name, description, price) VALUES
('Laptop', 'High-performance laptop', 1200.50),
('Smartphone', 'Latest smartphone model', 999.99),
('The Lord of the Rings', 'Fantasy novel', 15.00),
('T-Shirt', 'Cotton t-shirt', 20.00);

INSERT INTO product_categories (product_id, category_id) VALUES
(1, 1),
(2, 1),
(3, 2),
(4, 3);

CREATE VIEW product_details AS
SELECT
    p.name,
    p.price,
    c.name AS category
FROM
    products p
JOIN
    product_categories pc ON p.id = pc.product_id
JOIN
    categories c ON pc.category_id = c.id;

CREATE TRIGGER update_product_price
AFTER UPDATE OF price ON products
BEGIN
    INSERT INTO products (name, price) VALUES ('Price Change Audit', OLD.price); --Intentional type mismatch in `name` to potentially trigger errors
END;

CREATE VIRTUAL TABLE vtab USING fts5(content='products', id, name, description);

INSERT INTO vtab(rowid, name, description) SELECT id, name, description FROM products;

-- Testing PRAGMA features
PRAGMA integrity_check;
PRAGMA foreign_key_check;

--Testing UNIQUE constraint violation
INSERT INTO categories (name) VALUES ('Electronics');